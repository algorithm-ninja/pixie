#!/bin/sh

[ "$1" == "start" ] || exit

set -e

SERVER_URL=$(cat /proc/cmdline | grep -o 'pull=[^ ]*' | cut -f 2 -d =)
[ -z "$SERVER_URL" ] && exit

mount -t efivarfs efivarfs /sys/firmware/efi/efivars

time pixie-pull --source $SERVER_URL
pixie-set-boot-order --boot-order-path boot_order

echo Done, rebooting now...

sleep 10 # wait to allow reading messages

reboot

